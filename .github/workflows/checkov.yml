name: Checkov Custom Policy Scan

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install Checkov
        run: pip install checkov

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      # ------------------------------------------------
      # RUN YOUR SCANS (same as workflow 1)
      # ------------------------------------------------
      - name: Run Checkov scan (with custom policies)
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            -o json > checkov_results.json || true

      - name: Run Python ARN version pin check
        run: |
          python check_python_arn_version.py > pyarn_results.txt || true


      # ------------------------------------------------
      # INLINE PR COMMENTS (same logic as your workflow #2)
      # ------------------------------------------------
      - name: Post inline PR comments for Checkov failures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          if jq -e '.results.failed_checks | length > 0' checkov_results.json >/dev/null; then
            jq -c '.results.failed_checks[]' checkov_results.json | while read -r issue; do

              FILE_PATH=$(echo "$issue" | jq -r '.file_path')
              LINE=$(echo "$issue" | jq -r '.file_line_range[0]')
              BODY=$(echo "$issue" | jq -r '.check_id + ": " + .check_name')

              if [[ "$FILE_PATH" != "null" && "$LINE" != "null" ]]; then
                DISPLAY_PATH="${FILE_PATH#./}"
                echo "Posting Checkov inline comment â†’ $DISPLAY_PATH:$LINE"

                curl -s -X POST \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments" \
                  -d "{
                    \"body\": \"$BODY\",
                    \"commit_id\": \"$COMMIT_ID\",
                    \"path\": \"$DISPLAY_PATH\",
                    \"line\": $LINE
                  }"
              fi
            done
          fi

      - name: Post inline PR comments for Python ARN failures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          while read -r line; do
            [[ -z "$line" ]] && continue

            FILE=$(echo "$line" | awk '{print $1}')
            LINE=$(echo "$line" | awk '{print $2}')
            MSG="Python ARN Violation: $line"

            DISPLAY_PATH="${FILE#./}"

            echo "Posting ARN inline comment â†’ $DISPLAY_PATH:$LINE"

            curl -s -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments" \
              -d "{
                \"body\": \"$MSG\",
                \"commit_id\": \"$COMMIT_ID\",
                \"path\": \"$DISPLAY_PATH\",
                \"line\": $LINE
              }"

          done < pyarn_results.txt


      # ------------------------------------------------
      # REPORT OUTPUT EXACTLY LIKE WORKFLOW #2
      # ------------------------------------------------
      - name: Generate Report (exact format of workflow #2)
        run: |
          echo "# :shield: Security Scan Report" > report.md
          echo "" >> report.md

          CK_FAILED=$(jq '.results.failed_checks | length' checkov_results.json 2>/dev/null || echo 0)
          CK_PASSED=$(jq '.results.passed_checks | length' checkov_results.json 2>/dev/null || echo 0)
          CK_SKIPPED=$(jq '.results.skipped_checks | length' checkov_results.json 2>/dev/null || echo 0)
          PY_FAILED=$(grep -cve '^\s*$' pyarn_results.txt || echo 0)

          echo "1ï¸âƒ£ **Checkov Report**" >> report.md
          echo "   - ðŸŸ¢ **PASSED Checks:** $CK_PASSED" >> report.md
          echo "   - ðŸ”´ **FAILED Checks:** $CK_FAILED" >> report.md
          echo "   - âš ï¸ **SKIPPED Checks:** $CK_SKIPPED" >> report.md
          echo "" >> report.md

          echo "2ï¸âƒ£ **Python ARN Version Check**" >> report.md
          echo "   - ðŸ”´ **Violations:** $PY_FAILED" >> report.md
          echo "" >> report.md

          if [ "$CK_FAILED" -eq 0 ] && [ "$PY_FAILED" -eq 0 ]; then
            echo ":white_check_mark: Everything looks secure. Great job! ðŸ”" >> report.md
          else
            echo "*âš¡ï¸ Every ðŸ”´ is a risk bomb. Defuse before you MERGE!*" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          echo "## :cloud: Checkov Detailed Report" >> report.md
          if [ "$CK_FAILED" -gt 0 ]; then
            jq -r '
              .results.failed_checks[] |
              "### " + .check_id + "\n" +
              "- **Name:** " + .check_name + "\n" +
              "- **File:** `" + .file_path + "`" + "\n" +
              "- **Line:** " + (.file_line_range[0] | tostring) + "\n" +
              "- **Severity:** " + (.severity // "N/A") + "\n" +
              "- **Guideline:** " + (.guideline // "N/A") + "\n" +
              "- **Description:** " + (.description // "No description") + "\n---"
            ' checkov_results.json >> report.md
          else
            echo ":white_check_mark: **No Checkov issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          echo "## :snake: Python ARN Detailed Report" >> report.md
          if [ "$PY_FAILED" -gt 0 ]; then
            while read -r line; do
              echo "- $line" >> report.md
            done < pyarn_results.txt
          else
            echo ":white_check_mark: **No Python ARN issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "*Generated automatically by the Security Scan Pipeline*" >> report.md

      - name: Post Report to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: report.md

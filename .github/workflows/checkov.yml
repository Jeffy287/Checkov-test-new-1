name: Checkov Custom Policy Scan

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout Code
      # ---------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------
      # Setup Python
      # ---------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # ---------------------------
      # Install Checkov & GitHub CLI
      # ---------------------------
      - name: Install dependencies
        run: |
          pip install checkov
          sudo apt-get update && sudo apt-get install -y gh jq

      # ---------------------------
      # Run Checkov Scan
      # ---------------------------
      - name: Run Checkov scan
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            -o json > checkov_results.json || echo '{"results": {"failed_checks":[],"passed_checks":[],"skipped_checks":[]}}' > checkov_results.json

      # ---------------------------
      # Run Python ARN Version Check
      # ---------------------------
      - name: Run Python ARN check
        run: |
          python check_python_arn_version.py > pyarn_results.txt || touch pyarn_results.txt

      # ---------------------------
      # Generate Markdown Report
      # ---------------------------
      - name: Generate Security Report
        run: |
          echo "# :shield: Security Scan Report" > report.md
          echo "" >> report.md

          # Safe JSON parsing
          CK_FAILED=$(jq '.results.failed_checks | length // 0' checkov_results.json)
          CK_PASSED=$(jq '.results.passed_checks | length // 0' checkov_results.json)
          CK_SKIPPED=$(jq '.results.skipped_checks | length // 0' checkov_results.json)
          PY_FAILED=$(grep -cve '^\s*$' pyarn_results.txt || echo 0)

          # Summary
          echo "1ï¸âƒ£ **Checkov Report**" >> report.md
          echo "   - ðŸŸ¢ **PASSED Checks:** $CK_PASSED" >> report.md
          echo "   - ðŸ”´ **FAILED Checks:** $CK_FAILED" >> report.md
          echo "   - âš ï¸ **SKIPPED Checks:** $CK_SKIPPED" >> report.md
          echo "" >> report.md

          echo "2ï¸âƒ£ **Python ARN Version Check**" >> report.md
          echo "   - ðŸ”´ **Violations:** $PY_FAILED" >> report.md
          echo "" >> report.md

          if [ "$CK_FAILED" -eq 0 ] && [ "$PY_FAILED" -eq 0 ]; then
            echo ":white_check_mark: Everything looks secure. Great job! ðŸ”" >> report.md
          else
            echo "*âš¡ï¸ Every ðŸ”´ is a risk bomb. Defuse before you MERGE!*" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          # -------------------------
          # Detailed Checkov Failures
          # -------------------------
          echo "## :cloud: Checkov Detailed Report" >> report.md
          if [ "$CK_FAILED" -gt 0 ]; then
            jq -r '
              .results.failed_checks[]? |
              "### " + (.check_id // "N/A") + "\n" +
              "- **Name:** " + (.check_name // "N/A") + "\n" +
              "- **File:** `" + (.file_path // "N/A") + "`\n" +
              "- **Line:** " + ((.file_line_range[0] | tostring) // "?") + "\n" +
              "- **Severity:** " + (.severity // "N/A") + "\n" +
              "- **Guideline:** " + (.guideline // "N/A") + "\n" +
              "- **Description:** " + (.description // .check_name // "No description") + "\n---"
            ' checkov_results.json >> report.md
          else
            echo ":white_check_mark: **No Checkov issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          # -------------------------
          # Python ARN Details
          # -------------------------
          echo "## :snake: Python ARN Detailed Report" >> report.md
          if [ "$PY_FAILED" -gt 0 ]; then
            grep -v '^\s*$' pyarn_results.txt | while read -r line; do
              echo "- $line" >> report.md
            done
          else
            echo ":white_check_mark: **No Python ARN issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "*Generated automatically by the Security Scan Pipeline*" >> report.md

      # ---------------------------
      # Post Sticky PR Comment
      # ---------------------------
      - name: Post Report to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: report.md

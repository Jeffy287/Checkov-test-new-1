name: Checkov Custom Policy Inline Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Checkov, jq, and GitHub CLI
        run: |
          pip install checkov
          sudo apt-get update && sudo apt-get install -y jq gh

      - name: Run Checkov (JSON output)
        run: |
          checkov -d . --external-checks-dir ./custom-policies --quiet -o json > checkov_results.json || true
        continue-on-error: true

      - name: Run Python ARN Scan
        run: |
          python check_python_arn_version.py
        continue-on-error: true

      - name: Get Changed Files (Debug)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr diff $PR_NUMBER --name-only | sed 's|^./||' | sort | uniq > changed_files.txt
          echo "==== CHANGED FILES ===="
          cat changed_files.txt

      - name: Debug Output of ARN Scan
        run: |
          echo "==== ARN RESULTS ===="
          cat arn_results.json || echo "arn_results.json not found"
          echo "==== End ARN RESULTS ===="

      - name: Post Python ARN Review Comments (with full debug)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          if [ -f arn_results.json ] && jq -e 'type=="array"' arn_results.json > /dev/null 2>&1; then
            jq -c '.[]' arn_results.json | while read -r issue; do
              FILE=$(echo "$issue" | jq -r '.file')
              LINE=$(echo "$issue" | jq -r '.line')
              MSG=$(echo "$issue" | jq -r '.msg')
              echo "DEBUG: Issue FILE=$FILE LINE=$LINE MSG=$MSG"
              if grep -qx "$FILE" changed_files.txt; then
                if [[ -n "$FILE" && -n "$LINE" && -n "$MSG" ]]; then
                  echo "DEBUG: Attempting to post ARN review comment for $FILE:$LINE"
                  CURLRESP=$(curl -s -X POST \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments" \
                    -d "{
                      \"body\": \"$MSG\",
                      \"commit_id\": \"$COMMIT_ID\",
                      \"path\": \"$FILE\",
                      \"line\": $LINE
                    }")
                  echo "DEBUG: curl response: $CURLRESP"
                else
                  echo "DEBUG: Skipping, missing data: file=$FILE line=$LINE msg=$MSG"
                fi
              else
                echo "DEBUG: Skipping $FILE (not in PR diff)"
              fi
            done
          else
            echo "DEBUG: No ARN scan issues found or arn_results.json is not a JSON array."
          fi

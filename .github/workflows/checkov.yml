name: Checkov Custom Policy Scan

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov with custom policies
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            --output json > checkov_results.json || true
        continue-on-error: true

      - name: Run Python check
        run: |
          python check_python_arn_version.py > pyarn_results.txt || true
        continue-on-error: true

      # Extract Checkov failures to error files using jq (for JSON output)
      - name: Split Checkov Failures to Files
        run: |
          mkdir -p checkov_errors
          jq -c '.results.failed_checks[]' checkov_results.json | \
          while read -r issue; do
            file=$(echo "$issue" | jq -r '.file_path')
            line=$(echo "$issue" | jq -r '.file_line_range[0]')
            body=$(echo "$issue" | jq -r '"[" + .check_id + "] " + .check_name + "\n" + (.resource || "") + "\n" + .guideline')
            out="checkov_errors/$(echo $file | tr '/' '_')_${line}.txt"
            echo "$file" > "$out"
            echo "$line" >> "$out"
            echo "$body" >> "$out"
          done

      # Example Python output splitting: assumes format filename:line_number:message
      - name: Split Python Failures to Files
        run: |
          mkdir -p pyarn_errors
          n=0
          while IFS= read -r line; do
            filename=$(echo "$line" | cut -d: -f1)
            linenum=$(echo "$line" | cut -d: -f2)
            message=$(echo "$line" | cut -d: -f3-)
            if [ -n "$filename" ] && [ -n "$linenum" ] && [ -n "$message" ]; then
              out="pyarn_errors/$(echo $filename | tr '/' '_')_${linenum}.txt"
              echo "$filename" > "$out"
              echo "$linenum" >> "$out"
              echo "$message" >> "$out"
            fi
          done < pyarn_results.txt

      # Post Checkov failures as review comments
      - name: Post Checkov Review Comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          for file in checkov_errors/*.txt; do
            PATH_TO_FILE=$(head -n1 "$file")
            LINE=$(sed -n '2p' "$file")
            BODY=$(tail -n +3 "$file" | tr '\n' ' ')
            if [[ -n "$PATH_TO_FILE" && -n "$LINE" && -n "$BODY" ]]; then
              curl -L -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments" \
                -d "{
                  \"body\": \"$BODY\",
                  \"commit_id\": \"$COMMIT_ID\",
                  \"path\": \"$PATH_TO_FILE\",
                  \"line\": $LINE
                }"
            fi
          done

      # Post Python failures as review comments
      - name: Post Python Review Comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          for file in pyarn_errors/*.txt; do
            PATH_TO_FILE=$(head -n1 "$file")
            LINE=$(sed -n '2p' "$file")
            BODY=$(tail -n +3 "$file" | tr '\n' ' ')
            if [[ -n "$PATH_TO_FILE" && -n "$LINE" && -n "$BODY" ]]; then
              curl -L -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments" \
                -d "{
                  \"body\": \"$BODY\",
                  \"commit_id\": \"$COMMIT_ID\",
                  \"path\": \"$PATH_TO_FILE\",
                  \"line\": $LINE
                }"
            fi
          done

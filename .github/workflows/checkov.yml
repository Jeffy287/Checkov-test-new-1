name: Custom Policy Security Scan

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  custom-security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov (built-in and custom checks)
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            -o json > checkov-report.json || true

      - name: Run Python ARN version pin check
        run: |
          python check_python_arn_version.py --output-json pyarn-report.json || true

      - name: Format Reports
        run: |
          echo "# :shield: Custom Policy Security Scan Report" > report.md
          echo "" >> report.md

          # Checkov Results
          CHECKOV_JSON="checkov-report.json"
          CHECKOV_PASSED=$(jq '.summary.passed' "$CHECKOV_JSON" 2>/dev/null || echo "0")
          CHECKOV_FAILED=$(jq '.summary.failed' "$CHECKOV_JSON" 2>/dev/null || echo "0")
          CHECKOV_SKIPPED=$(jq '.summary.skipped' "$CHECKOV_JSON" 2>/dev/null || echo "0")
          
          echo "## 1ï¸âƒ£ Checkov Report" >> report.md
          echo "- ðŸŸ¢ **PASSED Checks:** $CHECKOV_PASSED" >> report.md
          echo "- ðŸ”´ **FAILED Checks:** $CHECKOV_FAILED" >> report.md
          echo "- âš ï¸  **SKIPPED Checks:** $CHECKOV_SKIPPED" >> report.md
          echo "" >> report.md

          # Detailed Checkov Failures
          echo "### :cloud: Checkov Detailed Failures" >> report.md
          if [ -f "$CHECKOV_JSON" ]; then
            FAILED=$(jq '.results.failed_checks | length' "$CHECKOV_JSON" 2>/dev/null || echo "0")
            if [ "$FAILED" -gt 0 ]; then
              jq -r '
                .results.failed_checks[]? |
                "- **" + (.check_id // "N/A") + ":** " + (.check_name // "N/A") + "\n" +
                (
                  if (.file_path // "") != "" and
                     ((.file_line_range | type) == "array" and (.file_line_range | length) > 0)
                  then
                    "  - **Location:** `" + (.file_path | ltrimstr("/")) + ":" + ((.file_line_range[0]|tostring) // "?") + "`\n"
                  elif .resource_address then
                    "  - **Resource:** `" + .resource_address + "`\n"
                  else "" end
                ) +
                "  - **Severity:** " + ((.severity // "N/A")) + "\n" +
                "  - **Guideline:** " + ((.guideline // "N/A")) + "\n" +
                "  - **Description:** " + ((.description // .check_name // "No description provided.")) + "\n"
              ' "$CHECKOV_JSON" >> report.md
            else
              echo ":white_check_mark: **No failed infrastructure checks found!**" >> report.md
            fi
          else
            echo ":warning: Checkov report not generated." >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md

          # Python ARN Report
          echo "## 2ï¸âƒ£ Python ARN Version Scan" >> report.md
          PYARN_JSON="pyarn-report.json"
          PYARN_FAILED=$(jq '.failures | length' "$PYARN_JSON" 2>/dev/null || echo "0")
          echo "- ðŸ”´ **FAILED Checks:** $PYARN_FAILED" >> report.md
          echo "" >> report.md

          # Detailed Python ARN Failures
          if [ -f "$PYARN_JSON" ]; then
            COUNT=$(jq '.failures | length' "$PYARN_JSON" 2>/dev/null || echo "0")
            if [ "$COUNT" -gt 0 ]; then
              jq -r '
                .failures[] |
                "- **File:** " + (.file // "N/A") + "\n" +
                "  - **Line:** " + ((.line | tostring) // "?") + "\n" +
                "  - **Issue:** " + (.issue // "N/A") + "\n"
              ' "$PYARN_JSON" >> report.md
            else
              echo ":white_check_mark: **No Python ARN issues found!**" >> report.md
            fi
          else
            echo ":warning: Python ARN report not generated." >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "*This report was generated automatically by the Custom Policy Security Scan Pipeline*" >> report.md

      - name: Post Scan Summary to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: report.md

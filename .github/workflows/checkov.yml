name: Checkov Custom Policy Scan

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Checkov
        run: pip install checkov

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      - name: Run Checkov Scan (custom + built-in)
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            -o json > checkov-report.json || true

      - name: Run Python ARN Version Check
        run: |
          python check_python_arn_version.py > pyarn-report.txt || true

      # ===================================================================
      # ðŸ”¥ INLINE PR COMMENTS JUST LIKE YOUR EXAMPLE WORKFLOW
      # ===================================================================
      - name: Post Inline PR Comments for Checkov Failures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          if jq -e '.results.failed_checks | length > 0' checkov-report.json >/dev/null; then
            jq -c '.results.failed_checks[]' checkov-report.json | while read -r issue; do
              
              PATH_TO_FILE=$(echo "$issue" | jq -r '.file_path')
              LINE=$(echo "$issue" | jq -r '.file_line_range[0]')
              BODY=$(echo "$issue" | jq -r '.check_id + ": " + .check_name')

              # Ensure valid inline comment fields
              if [[ "$PATH_TO_FILE" != "null" && "$LINE" != "null" ]]; then

                # The path must match exactly as shown in PR diff
                DISPLAY_PATH="${PATH_TO_FILE#./}"

                echo "Posting Checkov comment â†’ $DISPLAY_PATH:$LINE"

                curl -s -X POST \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/$REPO/pulls/$PR/comments" \
                  -d "{
                      \"body\": \"$BODY\",
                      \"commit_id\": \"$COMMIT_ID\",
                      \"path\": \"$DISPLAY_PATH\",
                      \"line\": $LINE
                  }"
              fi
            done
          else
            echo "No Checkov failures found."
          fi

      - name: Post Inline PR Comments for Python ARN Violations
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
          COMMIT_ID: ${{ github.event.pull_request.head.sha }}
        run: |
          n=1
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              FILE=$(echo "$line" | awk '{print $1}')
              LINENUM=$(echo "$line" | awk '{print $2}')
              BODY="Python ARN Check: ${line}"

              DISPLAY_PATH="${FILE#./}"

              echo "Posting Python ARN comment â†’ $DISPLAY_PATH:$LINENUM"

              curl -s -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/pulls/$PR/comments" \
                -d "{
                  \"body\": \"$BODY\",
                  \"commit_id\": \"$COMMIT_ID\",
                  \"path\": \"$DISPLAY_PATH\",
                  \"line\": $LINENUM
                }"
            fi
          done < pyarn-report.txt

      # ===================================================================
      # ðŸ”¥ EXACT REPORT OUTPUT STYLE FROM YOUR EXAMPLE WORKFLOW
      # ===================================================================
      - name: Generate Security Report
        run: |
          echo "# :shield: Security Scan Report" > report.md
          echo "" >> report.md

          CK_FAILED=$(jq '.results.failed_checks | length' checkov-report.json 2>/dev/null || echo 0)
          CK_PASSED=$(jq '.results.passed_checks | length' checkov-report.json 2>/dev/null || echo 0)
          CK_SKIPPED=$(jq '.results.skipped_checks | length' checkov-report.json 2>/dev/null || echo 0)
          PY_FAILED=$(grep -cve '^\s*$' pyarn-report.txt || echo 0)

          echo "1ï¸âƒ£ **Checkov Report**" >> report.md
          echo "   - ðŸŸ¢ **PASSED Checks:** $CK_PASSED" >> report.md
          echo "   - ðŸ”´ **FAILED Checks:** $CK_FAILED" >> report.md
          echo "   - âš ï¸ **SKIPPED Checks:** $CK_SKIPPED" >> report.md
          echo "" >> report.md

          echo "2ï¸âƒ£ **Python ARN Version Check**" >> report.md
          echo "   - ðŸ”´ **Violations:** $PY_FAILED" >> report.md
          echo "" >> report.md

          if [ "$CK_FAILED" -eq 0 ] && [ "$PY_FAILED" -eq 0 ]; then
            echo ":white_check_mark: Everything looks secure. Great job! ðŸ”" >> report.md
          else
            echo "*âš¡ï¸ Every ðŸ”´ is a risk bomb. Defuse before you MERGE!*" >> report.md
          fi
          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          echo "## :cloud: Checkov Detailed Report" >> report.md
          echo "" >> report.md

          if [ "$CK_FAILED" -gt 0 ]; then
            jq -r '
              .results.failed_checks[] |
              "### " + .check_id + "\n" +
              "- **Name:** " + .check_name + "\n" +
              "- **File:** `" + .file_path + "`" + "\n" +
              "- **Line:** " + (.file_line_range[0] | tostring) + "\n" +
              "- **Severity:** " + (.severity // "N/A") + "\n" +
              "- **Guideline:** " + (.guideline // "N/A") + "\n" +
              "- **Description:** " + (.description // "No description") + "\n---"
            ' checkov-report.json >> report.md
          else
            echo ":white_check_mark: **No Checkov issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "" >> report.md

          echo "## :snake: Python ARN Detailed Report" >> report.md
          echo "" >> report.md

          if [ "$PY_FAILED" -gt 0 ]; then
            while IFS= read -r line; do
              echo "- $line" >> report.md
            done < pyarn-report.txt
          else
            echo ":white_check_mark: **No ARN version issues found!**" >> report.md
          fi

          echo "" >> report.md
          echo "---" >> report.md
          echo "*Generated automatically by Security Scan Pipeline*" >> report.md

      - name: Post Security Scan Summary to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: report.md

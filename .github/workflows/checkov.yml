name: Checkov Custom Policy Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  checkov_custom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov (builtin + custom checks)
        run: |
          checkov -d . \
            --external-checks-dir ./custom-policies \
            -o json > checkov-report.json
        continue-on-error: true

      - name: Run Python ARN Version Pin Check
        run: python check_python_arn_version.py > arn-report.json
        continue-on-error: true

      ###########################################################
      # POST CHECKOV FAILURES AS PR COMMENTS
      ###########################################################
      - name: Comment Checkov Failures on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR: ${{ github.event.pull_request.number }}
          COMMIT: ${{ github.event.pull_request.head.sha }}
        run: |
          if jq -e '.results.failed_checks | length > 0' checkov-report.json > /dev/null; then
            jq -c '.results.failed_checks[]' checkov-report.json | while read -r issue; do
              FILE=$(echo "$issue" | jq -r '.file_path')
              LINE=$(echo "$issue" | jq -r '.file_line_range[0]')
              BODY=$(echo "$issue" | jq -r '.check_id + ": " + .check_name')

              [ -z "$FILE" ] && continue
              [ -z "$LINE" ] && continue

              echo "Posting PR comment for $BODY"

              curl -s -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/$REPO/pulls/$PR/comments \
                -d "{
                  \"body\": \"$BODY\",
                  \"commit_id\": \"$COMMIT\",
                  \"path\": \"$FILE\",
                  \"line\": $LINE
                }"
            done
          else
            echo "No Checkov failures"
          fi

      ###########################################################
      # GENERATE MARKDOWN REPORT
      ###########################################################
      - name: Generate Markdown Report
        run: |
          echo "# ðŸ” Custom Checkov Scan Report" > report.md
          echo "" >> report.md

          CHECKOV_PASSED=$(jq '.summary.passed' checkov-report.json 2>/dev/null || echo "0")
          CHECKOV_FAILED=$(jq '.summary.failed' checkov-report.json 2>/dev/null || echo "0")
          CHECKOV_SKIPPED=$(jq '.summary.skipped' checkov-report.json 2>/dev/null || echo "0")

          echo "## 1ï¸âƒ£ Checkov Summary" >> report.md
          echo "- ðŸŸ¢ Passed: $CHECKOV_PASSED" >> report.md
          echo "- ðŸ”´ Failed: $CHECKOV_FAILED" >> report.md
          echo "- âš ï¸ Skipped: $CHECKOV_SKIPPED" >> report.md
          echo "" >> report.md

          echo "## 2ï¸âƒ£ ARN Version Pin Script Output" >> report.md
          echo '```json' >> report.md
          cat arn-report.json >> report.md
          echo '```' >> report.md

          echo "" >> report.md
          echo "---" >> report.md
          echo "### ðŸŽ¯ Final Status" >> report.md
          if [ "$CHECKOV_FAILED" -eq 0 ]; then
            echo "âœ… All checks passed!" >> report.md
          else
            echo "âš ï¸ Some checks failed â€” please review comments above." >> report.md
          fi

      ###########################################################
      # SHOW SUMMARY IN GITHUB UI
      ###########################################################
      - name: Add Summary to GitHub UI
        run: |
          echo "## ðŸ” Custom Checkov Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY

      ###########################################################
      # STICKY PR COMMENT (updates automatically)
      ###########################################################
      - name: Post Sticky PR Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: report.md
